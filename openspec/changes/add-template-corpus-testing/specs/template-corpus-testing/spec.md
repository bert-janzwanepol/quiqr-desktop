# Spec: Template Corpus Testing

## ADDED Requirements

### Requirement: Backend corpus tests validate community template configs
The backend test suite SHALL include a corpus test that discovers locally-cloned community templates under `~/Quiqr/sites/`, loads each one through `WorkspaceConfigProvider`, and asserts that the resulting `WorkspaceConfig` passes Zod schema validation without errors.

#### Scenario: Template with valid model loads without Zod errors
- **WHEN** a community template is cloned at `~/Quiqr/sites/<name>/main/quiqr/model/`
- **THEN** `WorkspaceConfigProvider.getWorkspaceConfig()` returns a `WorkspaceConfig` that satisfies `workspaceConfigSchema` with no validation errors

#### Scenario: Some community templates not cloned locally
- **WHEN** one or more official community templates are absent from `~/Quiqr/sites/`
- **THEN** the corpus test skips those templates (does not fail) and logs each missing template name so the developer knows which templates were not covered

#### Scenario: No templates cloned locally
- **WHEN** no subdirectory under `~/Quiqr/sites/` contains a `quiqr/model/base.yaml`
- **THEN** the corpus test suite reports zero cases and passes, with a logged warning listing all 9 community templates as not found

#### Scenario: Template with an unknown field type
- **WHEN** a template's resolved `Field[]` tree contains a `type` value not present in the frontend `FieldRegistry`
- **THEN** the backend corpus test produces a named failure identifying the template name and unknown type

---

### Requirement: Backend corpus tests validate all field types are known
For each loaded template, the backend corpus test SHALL extract every `type` value from the fully-resolved `Field[]` tree (across all collections and singles) and assert each type exists in the canonical list of registered field types.

#### Scenario: All field types recognised
- **WHEN** every `type` in a template's field tree matches a known registered type
- **THEN** the field-type assertion passes for that template

#### Scenario: Unknown field type detected
- **WHEN** a `type` value such as `"legacy-widget"` appears in a template's field tree but is not in the registered type list
- **THEN** the test fails with a message: `"Template <name>: unknown field type 'legacy-widget' at path <path>"`

---

### Requirement: Frontend smoke tests render each template's fields without crashing
The frontend test suite SHALL include smoke tests that render `<FormProvider>` with the resolved `Field[]` from each template's collections and singles, and assert that no React rendering error is thrown.

#### Scenario: Template collection renders without error
- **WHEN** `FormProvider` is rendered with a template collection's `Field[]` and minimal mock data
- **THEN** the component tree mounts without throwing and the test passes

#### Scenario: Template with complex nested structure renders without error
- **WHEN** a template collection contains `accordion` fields with `dynFormSearchKey` and nested `nest` fields
- **THEN** `FormProvider` renders without producing "Nested field not found" errors or console errors

#### Scenario: Missing fixture file
- **WHEN** a fixture JSON file for a template does not exist under `packages/frontend/test/fixtures/templates/`
- **THEN** the smoke test for that template is skipped (not failed), with a note to run the fixture refresh script

---

### Requirement: Fixture files are generated by a refresh script
A script at `scripts/refresh-template-fixtures.ts` SHALL scan `~/Quiqr/sites/`, load each template via `WorkspaceConfigProvider`, and write the resolved `Field[]` for each collection and single as JSON files under `packages/frontend/test/fixtures/templates/<template-name>/`.

#### Scenario: Fixture refresh generates per-template JSON files
- **WHEN** the script is run and templates are present locally
- **THEN** one JSON file per collection/single is written to `packages/frontend/test/fixtures/templates/<template-name>/`

#### Scenario: Fixture refresh is idempotent
- **WHEN** the script is run twice without template changes
- **THEN** the output files are identical and no spurious git diff is produced

---

### Requirement: New changes that touch config loading or field rendering MUST include corpus test coverage
Any OpenSpec change whose implementation modifies `WorkspaceConfigProvider`, `WorkspaceConfigValidator`, `FieldRegistry`, or adds/removes a field type SHALL include a task to run the corpus tests locally and confirm all locally-available templates still pass before the change is archived.

#### Scenario: Feature change adds a new field type
- **WHEN** a change introduces a new `type` value in `FieldRegistry` and the corresponding SukohForm component
- **THEN** the change's tasks include: "Run corpus tests (`npm run test -w @quiqr/backend`) with templates present and confirm no new failures"

#### Scenario: Feature change modifies config loading
- **WHEN** a change modifies `WorkspaceConfigProvider` or `WorkspaceConfigValidator`
- **THEN** the change's tasks include: "Run corpus tests and confirm all locally-available templates still load without Zod errors"

#### Scenario: Change does not touch config or rendering
- **WHEN** a change only affects unrelated areas (e.g., sync, AI integration, UI theming)
- **THEN** no corpus test task is required (but running them anyway is encouraged)
